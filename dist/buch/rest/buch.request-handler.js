"use strict";
/* eslint-disable max-lines */
Object.defineProperty(exports, "__esModule", { value: true });
exports.BuchRequestHandler = void 0;
const tslib_1 = require("tslib");
const service_1 = require("../service");
const shared_1 = require("../../shared");
const json5_1 = tslib_1.__importDefault(require("json5"));
// export bei async und await:
// https://blogs.msdn.microsoft.com/typescript/2015/11/30/announcing-typescript-1-7
// http://tc39.github.io/ecmascript-export
// https://nemethgergely.com/async-function-best-practices#Using-async-functions-with-express
class BuchRequestHandler {
    constructor() {
        // Dependency Injection ggf. durch
        // * Awilix https://github.com/jeffijoe/awilix
        // * InversifyJS https://github.com/inversify/InversifyJS
        // * Node Dependency Injection https://github.com/zazoomauro/node-dependency-injection
        // * BottleJS https://github.com/young-steveo/bottlejs
        this.service = new service_1.BuchService();
    }
    // vgl Kotlin: Schluesselwort "suspend"
    // eslint-disable-next-line max-statements
    async findById(req, res) {
        const versionHeader = req.header('If-None-Match');
        shared_1.logger.debug(`BuchRequestHandler.findById(): versionHeader=${versionHeader}`);
        const { id } = req.params;
        shared_1.logger.debug(`BuchRequestHandler.findById(): id=${id}`);
        let buch;
        try {
            // vgl. Kotlin: Aufruf einer suspend-Function
            buch = await this.service.findById(id);
        }
        catch (err) {
            // Exception einer export async function bei der Ausfuehrung fangen:
            // https://strongloop.com/strongblog/comparing-node-js-promises-trycatch-zone-js-angular
            shared_1.logger.error(`BuchRequestHandler.findById(): error=${json5_1.default.stringify(err)}`);
            res.sendStatus(shared_1.HttpStatus.INTERNAL_ERROR);
            return;
        }
        if (buch === undefined) {
            shared_1.logger.debug('BuchRequestHandler.findById(): status=NOT_FOUND');
            res.sendStatus(shared_1.HttpStatus.NOT_FOUND);
            return;
        }
        shared_1.logger.debug(`BuchRequestHandler.findById(): buch=${json5_1.default.stringify(buch)}`);
        const versionDb = buch.__v;
        if (versionHeader === `"${versionDb}"`) {
            res.sendStatus(shared_1.HttpStatus.NOT_MODIFIED);
            return;
        }
        shared_1.logger.debug(`BuchRequestHandler.findById(): VersionDb=${versionDb}`);
        res.header('ETag', `"${versionDb}"`);
        const baseUri = shared_1.getBaseUri(req);
        // HATEOAS: Atom Links
        // eslint-disable-next-line no-underscore-dangle
        buch._links = {
            self: { href: `${baseUri}/${id}` },
            list: { href: `${baseUri}` },
            add: { href: `${baseUri}` },
            update: { href: `${baseUri}/${id}` },
            remove: { href: `${baseUri}/${id}` },
        };
        delete buch._id;
        delete buch.__v;
        delete buch.createdAt;
        delete buch.updatedAt;
        res.json(buch);
    }
    async find(req, res) {
        // z.B. https://.../buecher?titel=Alpha
        // => req.query = { titel: "Alpha' }
        const { query } = req;
        shared_1.logger.debug(`BuchRequestHandler.find(): queryParams=${json5_1.default.stringify(query)}`);
        let buecher;
        try {
            buecher = await this.service.find(query);
        }
        catch (err) {
            shared_1.logger.error(`BuchRequestHandler.find(): error=${json5_1.default.stringify(err)}`);
            res.sendStatus(shared_1.HttpStatus.INTERNAL_ERROR);
            return;
        }
        shared_1.logger.debug(`BuchRequestHandler.find(): buecher=${json5_1.default.stringify(buecher)}`);
        if (buecher.length === 0) {
            // Alternative: https://www.npmjs.com/package/http-errors
            // Damit wird aber auch der Stacktrace zum Client
            // uebertragen, weil das resultierende Fehlerobjekt
            // von Error abgeleitet ist.
            shared_1.logger.debug('BuchRequestHandler.find(): status = NOT_FOUND');
            res.sendStatus(shared_1.HttpStatus.NOT_FOUND);
            return;
        }
        const baseUri = shared_1.getBaseUri(req);
        // asynchrone for-of Schleife statt synchrones buecher.map()
        for await (const buch of buecher) {
            // HATEOAS: Atom Links je Buch
            // eslint-disable-next-line no-underscore-dangle
            buch._links = { self: { href: `${baseUri}/${buch._id}` } };
        }
        shared_1.logger.debug(`BuchRequestHandler.find(): buecher=${json5_1.default.stringify(buecher)}`);
        buecher.forEach((buch) => {
            delete buch._id;
            delete buch.__v;
            delete buch.createdAt;
            delete buch.updatedAt;
        });
        res.json(buecher);
    }
    async create(req, res) {
        const contentType = req.header(shared_1.mimeConfig.contentType);
        if (
        // Optional Chaining
        (contentType === null || contentType === void 0 ? void 0 : contentType.toLowerCase()) !== shared_1.mimeConfig.json) {
            shared_1.logger.debug('BuchRequestHandler.create() status=NOT_ACCEPTABLE');
            res.sendStatus(shared_1.HttpStatus.NOT_ACCEPTABLE);
            return;
        }
        const buchData = req.body; // eslint-disable-line @typescript-eslint/no-unsafe-assignment
        shared_1.logger.debug(`BuchRequestHandler.create(): body=${json5_1.default.stringify(buchData)}`);
        const result = await this.service.create(buchData);
        if (result instanceof service_1.BuchServiceError) {
            this.handleCreateError(result, res);
            return;
        }
        const buchSaved = result;
        const location = `${shared_1.getBaseUri(req)}/${buchSaved._id}`;
        shared_1.logger.debug(`BuchRequestHandler.create(): location=${location}`);
        res.location(location);
        res.sendStatus(shared_1.HttpStatus.CREATED);
    }
    async update(req, res) {
        var _a;
        const { id } = req.params;
        shared_1.logger.debug(`BuchRequestHandler.update(): id=${id}`);
        const contentType = req.header(shared_1.mimeConfig.contentType);
        if ((contentType === null || contentType === void 0 ? void 0 : contentType.toLowerCase()) !== shared_1.mimeConfig.json) {
            res.status(shared_1.HttpStatus.NOT_ACCEPTABLE);
            return;
        }
        const version = this.getVersionHeader(req, res);
        if (version === undefined) {
            return;
        }
        const buchData = req.body; // eslint-disable-line @typescript-eslint/no-unsafe-assignment
        buchData._id = id;
        shared_1.logger.debug(`BuchRequestHandler.update(): buch=${json5_1.default.stringify(buchData)}`);
        const result = await this.service.update(buchData, version);
        if (result instanceof service_1.BuchServiceError) {
            this.handleUpdateError(result, res);
            return;
        }
        shared_1.logger.debug(`BuchRequestHandler.update(): result=${json5_1.default.stringify(result)}`);
        const neueVersion = `"${(_a = result.__v) === null || _a === void 0 ? void 0 : _a.toString()}"`;
        res.set('ETag', neueVersion);
        res.sendStatus(shared_1.HttpStatus.NO_CONTENT);
    }
    async delete(req, res) {
        const { id } = req.params;
        shared_1.logger.debug(`BuchRequestHandler.delete(): id=${id}`);
        try {
            await this.service.delete(id);
        }
        catch (err) {
            shared_1.logger.error(`BuchRequestHandler.delete(): error=${json5_1.default.stringify(err)}`);
            res.sendStatus(shared_1.HttpStatus.INTERNAL_ERROR);
            return;
        }
        shared_1.logger.debug('BuchRequestHandler.delete(): NO_CONTENT');
        res.sendStatus(shared_1.HttpStatus.NO_CONTENT);
    }
    handleCreateError(err, res) {
        if (err instanceof service_1.BuchInvalid) {
            this.handleValidationError(err.msg, res);
            return;
        }
        if (err instanceof service_1.TitelExists) {
            this.handleTitelExists(err.titel, err.id, res);
            return;
        }
        if (err instanceof service_1.IsbnExists) {
            this.handleIsbnExists(err.isbn, err.id, res);
        }
    }
    handleIsbnExists(isbn, id, res) {
        const msg = `Die ISBN-Nummer "${isbn}" existiert bereits bei ${id}.`;
        shared_1.logger.debug(`BuchRequestHandler.handleCreateError(): msg=${msg}`);
        res.status(shared_1.HttpStatus.BAD_REQUEST)
            .set('Content-Type', 'text/plain')
            .send(msg);
    }
    handleValidationError(msg, res) {
        shared_1.logger.debug(`BuchRequestHandler.handleCreateError(): msg=${JSON.stringify(msg)}`);
        res.status(shared_1.HttpStatus.BAD_REQUEST).send(msg);
    }
    handleTitelExists(titel, id, res) {
        const msg = `Der Titel "${titel}" existiert bereits bei ${id}.`;
        shared_1.logger.debug(`BuchRequestHandler.handleCreateError(): msg=${msg}`);
        res.status(shared_1.HttpStatus.BAD_REQUEST)
            .set('Content-Type', 'text/plain')
            .send(msg);
    }
    getVersionHeader(req, res) {
        const versionHeader = req.header('If-Match');
        shared_1.logger.debug(`BuchRequestHandler.getVersionHeader() versionHeader=${versionHeader}`);
        if (versionHeader === undefined) {
            const msg = 'Versionsnummer fehlt';
            shared_1.logger.debug(`BuchRequestHandler.getVersionHeader(): status=428, message=${msg}`);
            res.status(shared_1.HttpStatus.PRECONDITION_REQUIRED)
                .set('Content-Type', 'text/plain')
                .send(msg);
            return;
        }
        const { length } = versionHeader;
        // eslint-disable-next-line @typescript-eslint/no-magic-numbers
        if (length < 3) {
            const msg = `Ungueltige Versionsnummer: ${versionHeader}`;
            shared_1.logger.debug(`BuchRequestHandler.getVersionHeader(): status=412, message=${msg}`);
            res.status(shared_1.HttpStatus.PRECONDITION_FAILED)
                .set('Content-Type', 'text/plain')
                .send(msg);
            return;
        }
        // slice: einschl. Start, ausschl. Ende
        const version = versionHeader.slice(1, -1);
        shared_1.logger.debug(`BuchRequestHandler.getVersionHeader(): version=${version}`);
        return version;
    }
    handleUpdateError(err, res) {
        if (err instanceof service_1.BuchInvalid) {
            this.handleValidationError(err.msg, res);
            return;
        }
        if (err instanceof service_1.BuchNotExists) {
            const { id } = err;
            const msg = `Es gibt kein Buch mit der ID "${id}".`;
            shared_1.logger.debug(`BuchRequestHandler.handleUpdateError(): msg=${msg}`);
            res.status(shared_1.HttpStatus.PRECONDITION_FAILED)
                .set('Content-Type', 'text/plain')
                .send(msg);
            return;
        }
        if (err instanceof service_1.TitelExists) {
            this.handleTitelExists(err.titel, err.id, res);
            return;
        }
        if (err instanceof service_1.VersionInvalid) {
            const { version } = err;
            const msg = `Die Versionsnummer "${version}" ist ungueltig.`;
            shared_1.logger.debug(`BuchRequestHandler.handleUpdateError(): msg=${msg}`);
            res.status(shared_1.HttpStatus.PRECONDITION_REQUIRED)
                .set('Content-Type', 'text/plain')
                .send(msg);
            return;
        }
        if (err instanceof service_1.VersionOutdated) {
            const { version } = err;
            const msg = `Die Versionsnummer "${version}" ist nicht aktuell.`;
            shared_1.logger.debug(`BuchRequestHandler.handleUpdateError(): msg=${msg}`);
            res.status(shared_1.HttpStatus.PRECONDITION_FAILED)
                .set('Content-Type', 'text/plain')
                .send(msg);
        }
    }
}
exports.BuchRequestHandler = BuchRequestHandler;
/* eslint-enable max-lines */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVjaC5yZXF1ZXN0LWhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYnVjaC9yZXN0L2J1Y2gucmVxdWVzdC1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw4QkFBOEI7Ozs7QUFvQjlCLHdDQVNvQjtBQUVwQix5Q0FBMEU7QUFFMUUsMERBQTBCO0FBRTFCLDhCQUE4QjtBQUM5QixtRkFBbUY7QUFDbkYsMENBQTBDO0FBQzFDLDZGQUE2RjtBQUU3RixNQUFhLGtCQUFrQjtJQUEvQjtRQUNJLGtDQUFrQztRQUNsQyw4Q0FBOEM7UUFDOUMseURBQXlEO1FBQ3pELHNGQUFzRjtRQUN0RixzREFBc0Q7UUFDckMsWUFBTyxHQUFHLElBQUkscUJBQVcsRUFBRSxDQUFDO0lBMFRqRCxDQUFDO0lBeFRHLHVDQUF1QztJQUN2QywwQ0FBMEM7SUFDMUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFZLEVBQUUsR0FBYTtRQUN0QyxNQUFNLGFBQWEsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2xELGVBQU0sQ0FBQyxLQUFLLENBQ1IsZ0RBQWdELGFBQWEsRUFBRSxDQUNsRSxDQUFDO1FBQ0YsTUFBTSxFQUFFLEVBQUUsRUFBRSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDMUIsZUFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUV4RCxJQUFJLElBQTBCLENBQUM7UUFDL0IsSUFBSTtZQUNBLDZDQUE2QztZQUM3QyxJQUFJLEdBQUcsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMxQztRQUFDLE9BQU8sR0FBWSxFQUFFO1lBQ25CLG9FQUFvRTtZQUNwRSx3RkFBd0Y7WUFDeEYsZUFBTSxDQUFDLEtBQUssQ0FDUix3Q0FBd0MsZUFBSyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFB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RCw2QkFBNkIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBtYXgtbGluZXMgKi9cblxuLypcbiAqIENvcHlyaWdodCAoQykgMjAxNiAtIHByZXNlbnQgSnVlcmdlbiBaaW1tZXJtYW5uLCBIb2Noc2NodWxlIEthcmxzcnVoZVxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiwgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBCdWNoRGF0YSwgVmFsaWRhdGlvbkVycm9yTXNnIH0gZnJvbSAnLi4vZW50aXR5JztcbmltcG9ydCB7XG4gICAgQnVjaEludmFsaWQsXG4gICAgQnVjaE5vdEV4aXN0cyxcbiAgICBCdWNoU2VydmljZSxcbiAgICBCdWNoU2VydmljZUVycm9yLFxuICAgIElzYm5FeGlzdHMsXG4gICAgVGl0ZWxFeGlzdHMsXG4gICAgVmVyc2lvbkludmFsaWQsXG4gICAgVmVyc2lvbk91dGRhdGVkLFxufSBmcm9tICcuLi9zZXJ2aWNlJztcbmltcG9ydCB0eXBlIHsgQ3JlYXRlRXJyb3IsIFVwZGF0ZUVycm9yIH0gZnJvbSAnLi4vc2VydmljZSc7XG5pbXBvcnQgeyBIdHRwU3RhdHVzLCBnZXRCYXNlVXJpLCBsb2dnZXIsIG1pbWVDb25maWcgfSBmcm9tICcuLi8uLi9zaGFyZWQnO1xuaW1wb3J0IHR5cGUgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IEpTT041IGZyb20gJ2pzb241JztcblxuLy8gZXhwb3J0IGJlaSBhc3luYyB1bmQgYXdhaXQ6XG4vLyBodHRwczovL2Jsb2dzLm1zZG4ubWljcm9zb2Z0LmNvbS90eXBlc2NyaXB0LzIwMTUvMTEvMzAvYW5ub3VuY2luZy10eXBlc2NyaXB0LTEtN1xuLy8gaHR0cDovL3RjMzkuZ2l0aHViLmlvL2VjbWFzY3JpcHQtZXhwb3J0XG4vLyBodHRwczovL25lbWV0aGdlcmdlbHkuY29tL2FzeW5jLWZ1bmN0aW9uLWJlc3QtcHJhY3RpY2VzI1VzaW5nLWFzeW5jLWZ1bmN0aW9ucy13aXRoLWV4cHJlc3NcblxuZXhwb3J0IGNsYXNzIEJ1Y2hSZXF1ZXN0SGFuZGxlciB7XG4gICAgLy8gRGVwZW5kZW5jeSBJbmplY3Rpb24gZ2dmLiBkdXJjaFxuICAgIC8vICogQXdpbGl4IGh0dHBzOi8vZ2l0aHViLmNvbS9qZWZmaWpvZS9hd2lsaXhcbiAgICAvLyAqIEludmVyc2lmeUpTIGh0dHBzOi8vZ2l0aHViLmNvbS9pbnZlcnNpZnkvSW52ZXJzaWZ5SlNcbiAgICAvLyAqIE5vZGUgRGVwZW5kZW5jeSBJbmplY3Rpb24gaHR0cHM6Ly9naXRodWIuY29tL3phem9vbWF1cm8vbm9kZS1kZXBlbmRlbmN5LWluamVjdGlvblxuICAgIC8vICogQm90dGxlSlMgaHR0cHM6Ly9naXRodWIuY29tL3lvdW5nLXN0ZXZlby9ib3R0bGVqc1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc2VydmljZSA9IG5ldyBCdWNoU2VydmljZSgpO1xuXG4gICAgLy8gdmdsIEtvdGxpbjogU2NobHVlc3NlbHdvcnQgXCJzdXNwZW5kXCJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LXN0YXRlbWVudHNcbiAgICBhc3luYyBmaW5kQnlJZChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3QgdmVyc2lvbkhlYWRlciA9IHJlcS5oZWFkZXIoJ0lmLU5vbmUtTWF0Y2gnKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgYEJ1Y2hSZXF1ZXN0SGFuZGxlci5maW5kQnlJZCgpOiB2ZXJzaW9uSGVhZGVyPSR7dmVyc2lvbkhlYWRlcn1gLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgICBsb2dnZXIuZGVidWcoYEJ1Y2hSZXF1ZXN0SGFuZGxlci5maW5kQnlJZCgpOiBpZD0ke2lkfWApO1xuXG4gICAgICAgIGxldCBidWNoOiBCdWNoRGF0YSB8IHVuZGVmaW5lZDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIHZnbC4gS290bGluOiBBdWZydWYgZWluZXIgc3VzcGVuZC1GdW5jdGlvblxuICAgICAgICAgICAgYnVjaCA9IGF3YWl0IHRoaXMuc2VydmljZS5maW5kQnlJZChpZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xuICAgICAgICAgICAgLy8gRXhjZXB0aW9uIGVpbmVyIGV4cG9ydCBhc3luYyBmdW5jdGlvbiBiZWkgZGVyIEF1c2Z1ZWhydW5nIGZhbmdlbjpcbiAgICAgICAgICAgIC8vIGh0dHBzOi8vc3Ryb25nbG9vcC5jb20vc3Ryb25nYmxvZy9jb21wYXJpbmctbm9kZS1qcy1wcm9taXNlcy10cnljYXRjaC16b25lLWpzLWFuZ3VsYXJcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgICAgICBgQnVjaFJlcXVlc3RIYW5kbGVyLmZpbmRCeUlkKCk6IGVycm9yPSR7SlNPTjUuc3RyaW5naWZ5KGVycil9YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXMuc2VuZFN0YXR1cyhIdHRwU3RhdHVzLklOVEVSTkFMX0VSUk9SKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChidWNoID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnQnVjaFJlcXVlc3RIYW5kbGVyLmZpbmRCeUlkKCk6IHN0YXR1cz1OT1RfRk9VTkQnKTtcbiAgICAgICAgICAgIHJlcy5zZW5kU3RhdHVzKEh0dHBTdGF0dXMuTk9UX0ZPVU5EKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgIGBCdWNoUmVxdWVzdEhhbmRsZXIuZmluZEJ5SWQoKTogYnVjaD0ke0pTT041LnN0cmluZ2lmeShidWNoKX1gLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCB2ZXJzaW9uRGIgPSBidWNoLl9fdjtcbiAgICAgICAgaWYgKHZlcnNpb25IZWFkZXIgPT09IGBcIiR7dmVyc2lvbkRifVwiYCkge1xuICAgICAgICAgICAgcmVzLnNlbmRTdGF0dXMoSHR0cFN0YXR1cy5OT1RfTU9ESUZJRUQpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgQnVjaFJlcXVlc3RIYW5kbGVyLmZpbmRCeUlkKCk6IFZlcnNpb25EYj0ke3ZlcnNpb25EYn1gKTtcbiAgICAgICAgcmVzLmhlYWRlcignRVRhZycsIGBcIiR7dmVyc2lvbkRifVwiYCk7XG5cbiAgICAgICAgY29uc3QgYmFzZVVyaSA9IGdldEJhc2VVcmkocmVxKTtcbiAgICAgICAgLy8gSEFURU9BUzogQXRvbSBMaW5rc1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5kZXJzY29yZS1kYW5nbGVcbiAgICAgICAgYnVjaC5fbGlua3MgPSB7XG4gICAgICAgICAgICBzZWxmOiB7IGhyZWY6IGAke2Jhc2VVcml9LyR7aWR9YCB9LFxuICAgICAgICAgICAgbGlzdDogeyBocmVmOiBgJHtiYXNlVXJpfWAgfSxcbiAgICAgICAgICAgIGFkZDogeyBocmVmOiBgJHtiYXNlVXJpfWAgfSxcbiAgICAgICAgICAgIHVwZGF0ZTogeyBocmVmOiBgJHtiYXNlVXJpfS8ke2lkfWAgfSxcbiAgICAgICAgICAgIHJlbW92ZTogeyBocmVmOiBgJHtiYXNlVXJpfS8ke2lkfWAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICBkZWxldGUgYnVjaC5faWQ7XG4gICAgICAgIGRlbGV0ZSBidWNoLl9fdjtcbiAgICAgICAgZGVsZXRlIGJ1Y2guY3JlYXRlZEF0O1xuICAgICAgICBkZWxldGUgYnVjaC51cGRhdGVkQXQ7XG4gICAgICAgIHJlcy5qc29uKGJ1Y2gpO1xuICAgIH1cblxuICAgIGFzeW5jIGZpbmQocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSB7XG4gICAgICAgIC8vIHouQi4gaHR0cHM6Ly8uLi4vYnVlY2hlcj90aXRlbD1BbHBoYVxuICAgICAgICAvLyA9PiByZXEucXVlcnkgPSB7IHRpdGVsOiBcIkFscGhhJyB9XG4gICAgICAgIGNvbnN0IHsgcXVlcnkgfSA9IHJlcTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgYEJ1Y2hSZXF1ZXN0SGFuZGxlci5maW5kKCk6IHF1ZXJ5UGFyYW1zPSR7SlNPTjUuc3RyaW5naWZ5KHF1ZXJ5KX1gLFxuICAgICAgICApO1xuXG4gICAgICAgIGxldCBidWVjaGVyOiBCdWNoRGF0YVtdO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYnVlY2hlciA9IGF3YWl0IHRoaXMuc2VydmljZS5maW5kKHF1ZXJ5KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyOiB1bmtub3duKSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICAgICAgYEJ1Y2hSZXF1ZXN0SGFuZGxlci5maW5kKCk6IGVycm9yPSR7SlNPTjUuc3RyaW5naWZ5KGVycil9YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXMuc2VuZFN0YXR1cyhIdHRwU3RhdHVzLklOVEVSTkFMX0VSUk9SKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgIGBCdWNoUmVxdWVzdEhhbmRsZXIuZmluZCgpOiBidWVjaGVyPSR7SlNPTjUuc3RyaW5naWZ5KGJ1ZWNoZXIpfWAsXG4gICAgICAgICk7XG4gICAgICAgIGlmIChidWVjaGVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgLy8gQWx0ZXJuYXRpdmU6IGh0dHBzOi8vd3d3Lm5wbWpzLmNvbS9wYWNrYWdlL2h0dHAtZXJyb3JzXG4gICAgICAgICAgICAvLyBEYW1pdCB3aXJkIGFiZXIgYXVjaCBkZXIgU3RhY2t0cmFjZSB6dW0gQ2xpZW50XG4gICAgICAgICAgICAvLyB1ZWJlcnRyYWdlbiwgd2VpbCBkYXMgcmVzdWx0aWVyZW5kZSBGZWhsZXJvYmpla3RcbiAgICAgICAgICAgIC8vIHZvbiBFcnJvciBhYmdlbGVpdGV0IGlzdC5cbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnQnVjaFJlcXVlc3RIYW5kbGVyLmZpbmQoKTogc3RhdHVzID0gTk9UX0ZPVU5EJyk7XG4gICAgICAgICAgICByZXMuc2VuZFN0YXR1cyhIdHRwU3RhdHVzLk5PVF9GT1VORCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBiYXNlVXJpID0gZ2V0QmFzZVVyaShyZXEpO1xuXG4gICAgICAgIC8vIGFzeW5jaHJvbmUgZm9yLW9mIFNjaGxlaWZlIHN0YXR0IHN5bmNocm9uZXMgYnVlY2hlci5tYXAoKVxuICAgICAgICBmb3IgYXdhaXQgKGNvbnN0IGJ1Y2ggb2YgYnVlY2hlcikge1xuICAgICAgICAgICAgLy8gSEFURU9BUzogQXRvbSBMaW5rcyBqZSBCdWNoXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW5kZXJzY29yZS1kYW5nbGVcbiAgICAgICAgICAgIGJ1Y2guX2xpbmtzID0geyBzZWxmOiB7IGhyZWY6IGAke2Jhc2VVcml9LyR7YnVjaC5faWR9YCB9IH07XG4gICAgICAgIH1cblxuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgICBgQnVjaFJlcXVlc3RIYW5kbGVyLmZpbmQoKTogYnVlY2hlcj0ke0pTT041LnN0cmluZ2lmeShidWVjaGVyKX1gLFxuICAgICAgICApO1xuICAgICAgICBidWVjaGVyLmZvckVhY2goKGJ1Y2gpID0+IHtcbiAgICAgICAgICAgIGRlbGV0ZSBidWNoLl9pZDtcbiAgICAgICAgICAgIGRlbGV0ZSBidWNoLl9fdjtcbiAgICAgICAgICAgIGRlbGV0ZSBidWNoLmNyZWF0ZWRBdDtcbiAgICAgICAgICAgIGRlbGV0ZSBidWNoLnVwZGF0ZWRBdDtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlcy5qc29uKGJ1ZWNoZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIGNyZWF0ZShyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3QgY29udGVudFR5cGUgPSByZXEuaGVhZGVyKG1pbWVDb25maWcuY29udGVudFR5cGUpO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICAvLyBPcHRpb25hbCBDaGFpbmluZ1xuICAgICAgICAgICAgY29udGVudFR5cGU/LnRvTG93ZXJDYXNlKCkgIT09IG1pbWVDb25maWcuanNvblxuICAgICAgICApIHtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnQnVjaFJlcXVlc3RIYW5kbGVyLmNyZWF0ZSgpIHN0YXR1cz1OT1RfQUNDRVBUQUJMRScpO1xuICAgICAgICAgICAgcmVzLnNlbmRTdGF0dXMoSHR0cFN0YXR1cy5OT1RfQUNDRVBUQUJMRSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBidWNoRGF0YSA9IHJlcS5ib2R5OyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnNhZmUtYXNzaWdubWVudFxuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgICBgQnVjaFJlcXVlc3RIYW5kbGVyLmNyZWF0ZSgpOiBib2R5PSR7SlNPTjUuc3RyaW5naWZ5KGJ1Y2hEYXRhKX1gLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuc2VydmljZS5jcmVhdGUoYnVjaERhdGEpO1xuICAgICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgQnVjaFNlcnZpY2VFcnJvcikge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVDcmVhdGVFcnJvcihyZXN1bHQsIHJlcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBidWNoU2F2ZWQgPSByZXN1bHQ7XG4gICAgICAgIGNvbnN0IGxvY2F0aW9uID0gYCR7Z2V0QmFzZVVyaShyZXEpfS8ke2J1Y2hTYXZlZC5faWR9YDtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBCdWNoUmVxdWVzdEhhbmRsZXIuY3JlYXRlKCk6IGxvY2F0aW9uPSR7bG9jYXRpb259YCk7XG4gICAgICAgIHJlcy5sb2NhdGlvbihsb2NhdGlvbik7XG4gICAgICAgIHJlcy5zZW5kU3RhdHVzKEh0dHBTdGF0dXMuQ1JFQVRFRCk7XG4gICAgfVxuXG4gICAgYXN5bmMgdXBkYXRlKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkge1xuICAgICAgICBjb25zdCB7IGlkIH0gPSByZXEucGFyYW1zO1xuICAgICAgICBsb2dnZXIuZGVidWcoYEJ1Y2hSZXF1ZXN0SGFuZGxlci51cGRhdGUoKTogaWQ9JHtpZH1gKTtcblxuICAgICAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlcS5oZWFkZXIobWltZUNvbmZpZy5jb250ZW50VHlwZSk7XG4gICAgICAgIGlmIChjb250ZW50VHlwZT8udG9Mb3dlckNhc2UoKSAhPT0gbWltZUNvbmZpZy5qc29uKSB7XG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuTk9UX0FDQ0VQVEFCTEUpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZlcnNpb24gPSB0aGlzLmdldFZlcnNpb25IZWFkZXIocmVxLCByZXMpO1xuICAgICAgICBpZiAodmVyc2lvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBidWNoRGF0YSA9IHJlcS5ib2R5OyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby11bnNhZmUtYXNzaWdubWVudFxuICAgICAgICBidWNoRGF0YS5faWQgPSBpZDtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgYEJ1Y2hSZXF1ZXN0SGFuZGxlci51cGRhdGUoKTogYnVjaD0ke0pTT041LnN0cmluZ2lmeShidWNoRGF0YSl9YCxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnNlcnZpY2UudXBkYXRlKGJ1Y2hEYXRhLCB2ZXJzaW9uKTtcbiAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIEJ1Y2hTZXJ2aWNlRXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlVXBkYXRlRXJyb3IocmVzdWx0LCByZXMpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgYEJ1Y2hSZXF1ZXN0SGFuZGxlci51cGRhdGUoKTogcmVzdWx0PSR7SlNPTjUuc3RyaW5naWZ5KHJlc3VsdCl9YCxcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgbmV1ZVZlcnNpb24gPSBgXCIke3Jlc3VsdC5fX3Y/LnRvU3RyaW5nKCl9XCJgO1xuICAgICAgICByZXMuc2V0KCdFVGFnJywgbmV1ZVZlcnNpb24pO1xuICAgICAgICByZXMuc2VuZFN0YXR1cyhIdHRwU3RhdHVzLk5PX0NPTlRFTlQpO1xuICAgIH1cblxuICAgIGFzeW5jIGRlbGV0ZShyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcztcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBCdWNoUmVxdWVzdEhhbmRsZXIuZGVsZXRlKCk6IGlkPSR7aWR9YCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2VydmljZS5kZWxldGUoaWQpO1xuICAgICAgICB9IGNhdGNoIChlcnI6IHVua25vd24pIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgICAgICBgQnVjaFJlcXVlc3RIYW5kbGVyLmRlbGV0ZSgpOiBlcnJvcj0ke0pTT041LnN0cmluZ2lmeShlcnIpfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVzLnNlbmRTdGF0dXMoSHR0cFN0YXR1cy5JTlRFUk5BTF9FUlJPUik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsb2dnZXIuZGVidWcoJ0J1Y2hSZXF1ZXN0SGFuZGxlci5kZWxldGUoKTogTk9fQ09OVEVOVCcpO1xuICAgICAgICByZXMuc2VuZFN0YXR1cyhIdHRwU3RhdHVzLk5PX0NPTlRFTlQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlQ3JlYXRlRXJyb3IoZXJyOiBDcmVhdGVFcnJvciwgcmVzOiBSZXNwb25zZSkge1xuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQnVjaEludmFsaWQpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlVmFsaWRhdGlvbkVycm9yKGVyci5tc2csIHJlcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgVGl0ZWxFeGlzdHMpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlVGl0ZWxFeGlzdHMoZXJyLnRpdGVsLCBlcnIuaWQsIHJlcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgSXNibkV4aXN0cykge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVJc2JuRXhpc3RzKGVyci5pc2JuLCBlcnIuaWQsIHJlcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZUlzYm5FeGlzdHMoaXNibjogc3RyaW5nLCBpZDogc3RyaW5nLCByZXM6IFJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IG1zZyA9IGBEaWUgSVNCTi1OdW1tZXIgXCIke2lzYm59XCIgZXhpc3RpZXJ0IGJlcmVpdHMgYmVpICR7aWR9LmA7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgQnVjaFJlcXVlc3RIYW5kbGVyLmhhbmRsZUNyZWF0ZUVycm9yKCk6IG1zZz0ke21zZ31gKTtcbiAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkJBRF9SRVFVRVNUKVxuICAgICAgICAgICAgLnNldCgnQ29udGVudC1UeXBlJywgJ3RleHQvcGxhaW4nKVxuICAgICAgICAgICAgLnNlbmQobXNnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVZhbGlkYXRpb25FcnJvcihtc2c6IFZhbGlkYXRpb25FcnJvck1zZywgcmVzOiBSZXNwb25zZSkge1xuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgICBgQnVjaFJlcXVlc3RIYW5kbGVyLmhhbmRsZUNyZWF0ZUVycm9yKCk6IG1zZz0ke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICAgIG1zZyxcbiAgICAgICAgICAgICl9YCxcbiAgICAgICAgKTtcbiAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLkJBRF9SRVFVRVNUKS5zZW5kKG1zZyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVUaXRlbEV4aXN0cyh0aXRlbDogc3RyaW5nLCBpZDogc3RyaW5nLCByZXM6IFJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnN0IG1zZyA9IGBEZXIgVGl0ZWwgXCIke3RpdGVsfVwiIGV4aXN0aWVydCBiZXJlaXRzIGJlaSAke2lkfS5gO1xuICAgICAgICBsb2dnZXIuZGVidWcoYEJ1Y2hSZXF1ZXN0SGFuZGxlci5oYW5kbGVDcmVhdGVFcnJvcigpOiBtc2c9JHttc2d9YCk7XG4gICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5CQURfUkVRVUVTVClcbiAgICAgICAgICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L3BsYWluJylcbiAgICAgICAgICAgIC5zZW5kKG1zZyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRWZXJzaW9uSGVhZGVyKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkge1xuICAgICAgICBjb25zdCB2ZXJzaW9uSGVhZGVyID0gcmVxLmhlYWRlcignSWYtTWF0Y2gnKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgYEJ1Y2hSZXF1ZXN0SGFuZGxlci5nZXRWZXJzaW9uSGVhZGVyKCkgdmVyc2lvbkhlYWRlcj0ke3ZlcnNpb25IZWFkZXJ9YCxcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAodmVyc2lvbkhlYWRlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjb25zdCBtc2cgPSAnVmVyc2lvbnNudW1tZXIgZmVobHQnO1xuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgICAgIGBCdWNoUmVxdWVzdEhhbmRsZXIuZ2V0VmVyc2lvbkhlYWRlcigpOiBzdGF0dXM9NDI4LCBtZXNzYWdlPSR7bXNnfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVzLnN0YXR1cyhIdHRwU3RhdHVzLlBSRUNPTkRJVElPTl9SRVFVSVJFRClcbiAgICAgICAgICAgICAgICAuc2V0KCdDb250ZW50LVR5cGUnLCAndGV4dC9wbGFpbicpXG4gICAgICAgICAgICAgICAgLnNlbmQobXNnKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSB2ZXJzaW9uSGVhZGVyO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW1hZ2ljLW51bWJlcnNcbiAgICAgICAgaWYgKGxlbmd0aCA8IDMpIHtcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGBVbmd1ZWx0aWdlIFZlcnNpb25zbnVtbWVyOiAke3ZlcnNpb25IZWFkZXJ9YDtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgICAgICBgQnVjaFJlcXVlc3RIYW5kbGVyLmdldFZlcnNpb25IZWFkZXIoKTogc3RhdHVzPTQxMiwgbWVzc2FnZT0ke21zZ31gLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5QUkVDT05ESVRJT05fRkFJTEVEKVxuICAgICAgICAgICAgICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L3BsYWluJylcbiAgICAgICAgICAgICAgICAuc2VuZChtc2cpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gc2xpY2U6IGVpbnNjaGwuIFN0YXJ0LCBhdXNzY2hsLiBFbmRlXG4gICAgICAgIGNvbnN0IHZlcnNpb24gPSB2ZXJzaW9uSGVhZGVyLnNsaWNlKDEsIC0xKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgYEJ1Y2hSZXF1ZXN0SGFuZGxlci5nZXRWZXJzaW9uSGVhZGVyKCk6IHZlcnNpb249JHt2ZXJzaW9ufWAsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiB2ZXJzaW9uO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlVXBkYXRlRXJyb3IoZXJyOiBVcGRhdGVFcnJvciwgcmVzOiBSZXNwb25zZSkge1xuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQnVjaEludmFsaWQpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlVmFsaWRhdGlvbkVycm9yKGVyci5tc2csIHJlcyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQnVjaE5vdEV4aXN0cykge1xuICAgICAgICAgICAgY29uc3QgeyBpZCB9ID0gZXJyO1xuICAgICAgICAgICAgY29uc3QgbXNnID0gYEVzIGdpYnQga2VpbiBCdWNoIG1pdCBkZXIgSUQgXCIke2lkfVwiLmA7XG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoYEJ1Y2hSZXF1ZXN0SGFuZGxlci5oYW5kbGVVcGRhdGVFcnJvcigpOiBtc2c9JHttc2d9YCk7XG4gICAgICAgICAgICByZXMuc3RhdHVzKEh0dHBTdGF0dXMuUFJFQ09ORElUSU9OX0ZBSUxFRClcbiAgICAgICAgICAgICAgICAuc2V0KCdDb250ZW50LVR5cGUnLCAndGV4dC9wbGFpbicpXG4gICAgICAgICAgICAgICAgLnNlbmQobXNnKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBUaXRlbEV4aXN0cykge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVUaXRlbEV4aXN0cyhlcnIudGl0ZWwsIGVyci5pZCwgcmVzKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBWZXJzaW9uSW52YWxpZCkge1xuICAgICAgICAgICAgY29uc3QgeyB2ZXJzaW9uIH0gPSBlcnI7XG4gICAgICAgICAgICBjb25zdCBtc2cgPSBgRGllIFZlcnNpb25zbnVtbWVyIFwiJHt2ZXJzaW9ufVwiIGlzdCB1bmd1ZWx0aWcuYDtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgQnVjaFJlcXVlc3RIYW5kbGVyLmhhbmRsZVVwZGF0ZUVycm9yKCk6IG1zZz0ke21zZ31gKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5QUkVDT05ESVRJT05fUkVRVUlSRUQpXG4gICAgICAgICAgICAgICAgLnNldCgnQ29udGVudC1UeXBlJywgJ3RleHQvcGxhaW4nKVxuICAgICAgICAgICAgICAgIC5zZW5kKG1zZyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgVmVyc2lvbk91dGRhdGVkKSB7XG4gICAgICAgICAgICBjb25zdCB7IHZlcnNpb24gfSA9IGVycjtcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGBEaWUgVmVyc2lvbnNudW1tZXIgXCIke3ZlcnNpb259XCIgaXN0IG5pY2h0IGFrdHVlbGwuYDtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgQnVjaFJlcXVlc3RIYW5kbGVyLmhhbmRsZVVwZGF0ZUVycm9yKCk6IG1zZz0ke21zZ31gKTtcbiAgICAgICAgICAgIHJlcy5zdGF0dXMoSHR0cFN0YXR1cy5QUkVDT05ESVRJT05fRkFJTEVEKVxuICAgICAgICAgICAgICAgIC5zZXQoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L3BsYWluJylcbiAgICAgICAgICAgICAgICAuc2VuZChtc2cpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKiBlc2xpbnQtZW5hYmxlIG1heC1saW5lcyAqL1xuIl19