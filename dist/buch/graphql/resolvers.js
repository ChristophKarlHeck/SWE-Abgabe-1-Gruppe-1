"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolvers = void 0;
const errors_1 = require("./../service/errors");
const service_1 = require("../service");
// import type { IResolvers } from 'graphql-tools';
const shared_1 = require("../../shared");
const buchService = new service_1.BuchService();
// https://www.apollographql.com/docs/apollo-server/data/resolvers
// Zugriff auf Header-Daten, z.B. Token
// https://www.apollographql.com/docs/apollo-server/migration-two-dot/#accessing-request-headers
// https://www.apollographql.com/docs/apollo-server/security/authentication
// Resultat mit id (statt _id) und version (statt __v)
// __ ist bei GraphQL fuer interne Zwecke reserviert
const withIdAndVersion = (buch) => {
    const result = buch;
    result.id = buch._id;
    result.version = buch.__v;
    return buch;
};
const findBuchById = async (id) => {
    const buch = await buchService.findById(id);
    if (buch === undefined) {
        return;
    }
    return withIdAndVersion(buch);
};
const findBuecher = async (titel) => {
    const suchkriterium = titel === undefined ? {} : { titel };
    const buecher = await buchService.find(suchkriterium);
    return buecher.map((buch) => withIdAndVersion(buch));
};
const createBuch = async (buch) => {
    buch.datum = new Date(buch.datum);
    const result = await buchService.create(buch);
    console.log(`resolvers createBuch(): result=${JSON.stringify(result)}`);
    return result;
};
const logUpdateResult = (result) => {
    if (result instanceof errors_1.BuchInvalid) {
        shared_1.logger.debug(`resolvers updateBuch(): validation msg = ${JSON.stringify(result.msg)}`);
    }
    else if (result instanceof errors_1.TitelExists) {
        shared_1.logger.debug(`resolvers updateBuch(): vorhandener titel = ${result.titel}`);
    }
    else if (result instanceof errors_1.BuchNotExists) {
        shared_1.logger.debug(`resolvers updateBuch(): nicht-vorhandene id = ${result.id}`);
    }
    else if (result instanceof errors_1.VersionInvalid) {
        shared_1.logger.debug(`resolvers updateBuch(): ungueltige version = ${result.version}`);
    }
    else if (result instanceof errors_1.VersionOutdated) {
        shared_1.logger.debug(`resolvers updateBuch(): alte version = ${result.version}`);
    }
    else {
        shared_1.logger.debug(`resolvers updateBuch(): buch aktualisiert = ${JSON.stringify(result)}`);
        // TODO hier wird getrickst, um __v als "version" im Resultat zu haben
        const updateResult = result;
        updateResult.version = result.__v;
    }
};
const updateBuch = async (buch) => {
    var _a;
    shared_1.logger.debug(`resolvers updateBuch(): zu aktualisieren = ${JSON.stringify(buch)}`);
    const version = (_a = buch.__v) !== null && _a !== void 0 ? _a : 0;
    buch.datum = new Date(buch.datum);
    const result = await buchService.update(buch, version.toString());
    logUpdateResult(result);
    return result;
};
const deleteBuch = async (id) => {
    const result = await buchService.delete(id);
    shared_1.logger.debug(`resolvers deleteBuch(): result = ${result}`);
    return result;
};
// Queries passend zu "type Query" in typeDefs.ts
const query = {
    // Buecher suchen, ggf. mit Titel als Suchkriterium
    buecher: (_, { titel }) => findBuecher(titel),
    // Ein Buch mit einer bestimmten ID suchen
    buch: (_, { id }) => findBuchById(id),
};
const mutation = {
    createBuch: (_, buch) => createBuch(buch),
    updateBuch: (_, buch) => updateBuch(buch),
    deleteBuch: (_, { id }) => deleteBuch(id),
};
exports.resolvers /* : IResolvers */ = {
    Query: query,
    Mutation: mutation,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZXJzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2J1Y2gvZ3JhcGhxbC9yZXNvbHZlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsZ0RBTTZCO0FBbUI3Qix3Q0FBeUM7QUFDekMsbURBQW1EO0FBQ25ELHlDQUFzQztBQUV0QyxNQUFNLFdBQVcsR0FBRyxJQUFJLHFCQUFXLEVBQUUsQ0FBQztBQUV0QyxrRUFBa0U7QUFDbEUsdUNBQXVDO0FBQ3ZDLGdHQUFnRztBQUNoRywyRUFBMkU7QUFFM0Usc0RBQXNEO0FBQ3RELG9EQUFvRDtBQUNwRCxNQUFNLGdCQUFnQixHQUFHLENBQUMsSUFBVSxFQUFFLEVBQUU7SUFDcEMsTUFBTSxNQUFNLEdBQVEsSUFBSSxDQUFDO0lBQ3pCLE1BQU0sQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUNyQixNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDMUIsT0FBTyxJQUFJLENBQUM7QUFDaEIsQ0FBQyxDQUFDO0FBRUYsTUFBTSxZQUFZLEdBQUcsS0FBSyxFQUFFLEVBQVUsRUFBRSxFQUFFO0lBQ3RDLE1BQU0sSUFBSSxHQUFHLE1BQU0sV0FBVyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM1QyxJQUFJLElBQUksS0FBSyxTQUFTLEVBQUU7UUFDcEIsT0FBTztLQUNWO0lBQ0QsT0FBTyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNsQyxDQUFDLENBQUM7QUFFRixNQUFNLFdBQVcsR0FBRyxLQUFLLEVBQUUsS0FBeUIsRUFBRSxFQUFFO0lBQ3BELE1BQU0sYUFBYSxHQUFHLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQztJQUMzRCxNQUFNLE9BQU8sR0FBRyxNQUFNLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxD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Q25ELE9BQU8sRUFBRSxDQUFDLENBQVUsRUFBRSxFQUFFLEtBQUssRUFBaUIsRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQztJQUNyRSwwQ0FBMEM7SUFDMUMsSUFBSSxFQUFFLENBQUMsQ0FBVSxFQUFFLEVBQUUsRUFBRSxFQUFjLEVBQUUsRUFBRSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUM7Q0FDN0QsQ0FBQztBQUVGLE1BQU0sUUFBUSxHQUFHO0lBQ2IsVUFBVSxFQUFFLENBQUMsQ0FBVSxFQUFFLElBQVUsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztJQUN4RCxVQUFVLEVBQUUsQ0FBQyxDQUFVLEVBQUUsSUFBVSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDO0lBQ3hELFVBQVUsRUFBRSxDQUFDLENBQVUsRUFBRSxFQUFFLEVBQUUsRUFBYyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO0NBQ2pFLENBQUM7QUFFVyxRQUFBLFNBQVMsQ0FBQyxrQkFBa0IsR0FBRztJQUN4QyxLQUFLLEVBQUUsS0FBSztJQUNaLFFBQVEsRUFBRSxRQUFRO0NBQ3JCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIEJ1Y2hJbnZhbGlkLFxuICAgIEJ1Y2hOb3RFeGlzdHMsXG4gICAgVGl0ZWxFeGlzdHMsXG4gICAgVmVyc2lvbkludmFsaWQsXG4gICAgVmVyc2lvbk91dGRhdGVkLFxufSBmcm9tICcuLy4uL3NlcnZpY2UvZXJyb3JzJztcbi8qXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTggLSBwcmVzZW50IEp1ZXJnZW4gWmltbWVybWFubiwgSG9jaHNjaHVsZSBLYXJsc3J1aGVcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbmltcG9ydCB0eXBlIHsgQnVjaCB9IGZyb20gJy4vLi4vZW50aXR5JztcbmltcG9ydCB7IEJ1Y2hTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZSc7XG4vLyBpbXBvcnQgdHlwZSB7IElSZXNvbHZlcnMgfSBmcm9tICdncmFwaHFsLXRvb2xzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uLy4uL3NoYXJlZCc7XG5cbmNvbnN0IGJ1Y2hTZXJ2aWNlID0gbmV3IEJ1Y2hTZXJ2aWNlKCk7XG5cbi8vIGh0dHBzOi8vd3d3LmFwb2xsb2dyYXBocWwuY29tL2RvY3MvYXBvbGxvLXNlcnZlci9kYXRhL3Jlc29sdmVyc1xuLy8gWnVncmlmZiBhdWYgSGVhZGVyLURhdGVuLCB6LkIuIFRva2VuXG4vLyBodHRwczovL3d3dy5hcG9sbG9ncmFwaHFsLmNvbS9kb2NzL2Fwb2xsby1zZXJ2ZXIvbWlncmF0aW9uLXR3by1kb3QvI2FjY2Vzc2luZy1yZXF1ZXN0LWhlYWRlcnNcbi8vIGh0dHBzOi8vd3d3LmFwb2xsb2dyYXBocWwuY29tL2RvY3MvYXBvbGxvLXNlcnZlci9zZWN1cml0eS9hdXRoZW50aWNhdGlvblxuXG4vLyBSZXN1bHRhdCBtaXQgaWQgKHN0YXR0IF9pZCkgdW5kIHZlcnNpb24gKHN0YXR0IF9fdilcbi8vIF9fIGlzdCBiZWkgR3JhcGhRTCBmdWVyIGludGVybmUgWndlY2tlIHJlc2VydmllcnRcbmNvbnN0IHdpdGhJZEFuZFZlcnNpb24gPSAoYnVjaDogQnVjaCkgPT4ge1xuICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYnVjaDtcbiAgICByZXN1bHQuaWQgPSBidWNoLl9pZDtcbiAgICByZXN1bHQudmVyc2lvbiA9IGJ1Y2guX192O1xuICAgIHJldHVybiBidWNoO1xufTtcblxuY29uc3QgZmluZEJ1Y2hCeUlkID0gYXN5bmMgKGlkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBidWNoID0gYXdhaXQgYnVjaFNlcnZpY2UuZmluZEJ5SWQoaWQpO1xuICAgIGlmIChidWNoID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gd2l0aElkQW5kVmVyc2lvbihidWNoKTtcbn07XG5cbmNvbnN0IGZpbmRCdWVjaGVyID0gYXN5bmMgKHRpdGVsOiBzdHJpbmcgfCB1bmRlZmluZWQpID0+IHtcbiAgICBjb25zdCBzdWNoa3JpdGVyaXVtID0gdGl0ZWwgPT09IHVuZGVmaW5lZCA/IHt9IDogeyB0aXRlbCB9O1xuICAgIGNvbnN0IGJ1ZWNoZXIgPSBhd2FpdCBidWNoU2VydmljZS5maW5kKHN1Y2hrcml0ZXJpdW0pO1xuICAgIHJldHVybiBidWVjaGVyLm1hcCgoYnVjaCkgPT4gd2l0aElkQW5kVmVyc2lvbihidWNoKSk7XG59O1xuXG5pbnRlcmZhY2UgVGl0ZWxDcml0ZXJpYSB7XG4gICAgdGl0ZWw6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElkQ3JpdGVyaWEge1xuICAgIGlkOiBzdHJpbmc7XG59XG5cbmNvbnN0IGNyZWF0ZUJ1Y2ggPSBhc3luYyAoYnVjaDogQnVjaCkgPT4ge1xuICAgIGJ1Y2guZGF0dW0gPSBuZXcgRGF0ZShidWNoLmRhdHVtIGFzIHN0cmluZyk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYnVjaFNlcnZpY2UuY3JlYXRlKGJ1Y2gpO1xuICAgIGNvbnNvbGUubG9nKGByZXNvbHZlcnMgY3JlYXRlQnVjaCgpOiByZXN1bHQ9JHtKU09OLnN0cmluZ2lmeShyZXN1bHQpfWApO1xuICAgIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCBsb2dVcGRhdGVSZXN1bHQgPSAoXG4gICAgcmVzdWx0OlxuICAgICAgICB8IEJ1Y2hcbiAgICAgICAgfCBCdWNoSW52YWxpZFxuICAgICAgICB8IFRpdGVsRXhpc3RzXG4gICAgICAgIHwgQnVjaE5vdEV4aXN0c1xuICAgICAgICB8IFZlcnNpb25JbnZhbGlkXG4gICAgICAgIHwgVmVyc2lvbk91dGRhdGVkLFxuKSA9PiB7XG4gICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIEJ1Y2hJbnZhbGlkKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgIGByZXNvbHZlcnMgdXBkYXRlQnVjaCgpOiB2YWxpZGF0aW9uIG1zZyA9ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICAgICAgcmVzdWx0Lm1zZyxcbiAgICAgICAgICAgICl9YCxcbiAgICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFRpdGVsRXhpc3RzKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgIGByZXNvbHZlcnMgdXBkYXRlQnVjaCgpOiB2b3JoYW5kZW5lciB0aXRlbCA9ICR7cmVzdWx0LnRpdGVsfWAsXG4gICAgICAgICk7XG4gICAgfSBlbHNlIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBCdWNoTm90RXhpc3RzKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgIGByZXNvbHZlcnMgdXBkYXRlQnVjaCgpOiBuaWNodC12b3JoYW5kZW5lIGlkID0gJHtyZXN1bHQuaWR9YCxcbiAgICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFZlcnNpb25JbnZhbGlkKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAgIGByZXNvbHZlcnMgdXBkYXRlQnVjaCgpOiB1bmd1ZWx0aWdlIHZlcnNpb24gPSAke3Jlc3VsdC52ZXJzaW9ufWAsXG4gICAgICAgICk7XG4gICAgfSBlbHNlIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBWZXJzaW9uT3V0ZGF0ZWQpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgICAgYHJlc29sdmVycyB1cGRhdGVCdWNoKCk6IGFsdGUgdmVyc2lvbiA9ICR7cmVzdWx0LnZlcnNpb259YCxcbiAgICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZGVidWcoXG4gICAgICAgICAgICBgcmVzb2x2ZXJzIHVwZGF0ZUJ1Y2goKTogYnVjaCBha3R1YWxpc2llcnQgPSAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgICAgIHJlc3VsdCxcbiAgICAgICAgICAgICl9YCxcbiAgICAgICAgKTtcbiAgICAgICAgLy8gVE9ETyBoaWVyIHdpcmQgZ2V0cmlja3N0LCB1bSBfX3YgYWxzIFwidmVyc2lvblwiIGltIFJlc3VsdGF0IHp1IGhhYmVuXG4gICAgICAgIGNvbnN0IHVwZGF0ZVJlc3VsdDogYW55ID0gcmVzdWx0O1xuICAgICAgICB1cGRhdGVSZXN1bHQudmVyc2lvbiA9IHJlc3VsdC5fX3Y7XG4gICAgfVxufTtcblxuY29uc3QgdXBkYXRlQnVjaCA9IGFzeW5jIChidWNoOiBCdWNoKSA9PiB7XG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICBgcmVzb2x2ZXJzIHVwZGF0ZUJ1Y2goKTogenUgYWt0dWFsaXNpZXJlbiA9ICR7SlNPTi5zdHJpbmdpZnkoYnVjaCl9YCxcbiAgICApO1xuICAgIGNvbnN0IHZlcnNpb24gPSBidWNoLl9fdiA/PyAwO1xuICAgIGJ1Y2guZGF0dW0gPSBuZXcgRGF0ZShidWNoLmRhdHVtIGFzIHN0cmluZyk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYnVjaFNlcnZpY2UudXBkYXRlKGJ1Y2gsIHZlcnNpb24udG9TdHJpbmcoKSk7XG4gICAgbG9nVXBkYXRlUmVzdWx0KHJlc3VsdCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmNvbnN0IGRlbGV0ZUJ1Y2ggPSBhc3luYyAoaWQ6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGJ1Y2hTZXJ2aWNlLmRlbGV0ZShpZCk7XG4gICAgbG9nZ2VyLmRlYnVnKGByZXNvbHZlcnMgZGVsZXRlQnVjaCgpOiByZXN1bHQgPSAke3Jlc3VsdH1gKTtcbiAgICByZXR1cm4gcmVzdWx0O1xufTtcblxuLy8gUXVlcmllcyBwYXNzZW5kIHp1IFwidHlwZSBRdWVyeVwiIGluIHR5cGVEZWZzLnRzXG5jb25zdCBxdWVyeSA9IHtcbiAgICAvLyBCdWVjaGVyIHN1Y2hlbiwgZ2dmLiBtaXQgVGl0ZWwgYWxzIFN1Y2hrcml0ZXJpdW1cbiAgICBidWVjaGVyOiAoXzogdW5rbm93biwgeyB0aXRlbCB9OiBUaXRlbENyaXRlcmlhKSA9PiBmaW5kQnVlY2hlcih0aXRlbCksXG4gICAgLy8gRWluIEJ1Y2ggbWl0IGVpbmVyIGJlc3RpbW10ZW4gSUQgc3VjaGVuXG4gICAgYnVjaDogKF86IHVua25vd24sIHsgaWQgfTogSWRDcml0ZXJpYSkgPT4gZmluZEJ1Y2hCeUlkKGlkKSxcbn07XG5cbmNvbnN0IG11dGF0aW9uID0ge1xuICAgIGNyZWF0ZUJ1Y2g6IChfOiB1bmtub3duLCBidWNoOiBCdWNoKSA9PiBjcmVhdGVCdWNoKGJ1Y2gpLFxuICAgIHVwZGF0ZUJ1Y2g6IChfOiB1bmtub3duLCBidWNoOiBCdWNoKSA9PiB1cGRhdGVCdWNoKGJ1Y2gpLFxuICAgIGRlbGV0ZUJ1Y2g6IChfOiB1bmtub3duLCB7IGlkIH06IElkQ3JpdGVyaWEpID0+IGRlbGV0ZUJ1Y2goaWQpLFxufTtcblxuZXhwb3J0IGNvbnN0IHJlc29sdmVycyAvKiA6IElSZXNvbHZlcnMgKi8gPSB7XG4gICAgUXVlcnk6IHF1ZXJ5LCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uYW1pbmctY29udmVudGlvblxuICAgIE11dGF0aW9uOiBtdXRhdGlvbiwgLy8gZXNsaW50LWRpc2FibGUtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbmFtaW5nLWNvbnZlbnRpb25cbn07XG4iXX0=